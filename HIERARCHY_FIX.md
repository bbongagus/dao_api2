# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π –ø—Ä–∏ WebSocket –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ WebSocket –æ–ø–µ—Ä–∞—Ü–∏–π (—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–¥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏) –∏–µ—Ä–∞—Ä—Ö–∏—è parent-child —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ Redis –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç "—Å–ø–ª—é—â–∏–≤–∞–Ω–∏–µ" —Å—Ç—Ä—É–∫—Ç—É—Ä—ã - –≤—Å–µ –Ω–æ–¥—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∫–æ—Ä–Ω–µ–≤—ã–º–∏.

## –ü—Ä–∏—á–∏–Ω–∞
1. –°–µ—Ä–≤–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ Redis (—Å—Ç—Ä–æ–∫–∏ 170-192 –≤ `simple-server.js`)
2. –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ `GRAPH_STATE` —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
3. –ù–æ –∫–ª–∏–µ–Ω—Ç –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ `handleGraphState` –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É

## –¢–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ WebSocket:
1. –ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–¥—É —Å `parentId`
2. –°–µ—Ä–≤–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–¥—É –∫–∞–∫ child –≤ `applyOperation`
3. –°–µ—Ä–≤–µ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏—é –≤ Redis
4. –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º

### –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–ø—Ä–æ–±–ª–µ–º–∞ –∑–¥–µ—Å—å):
1. –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `SUBSCRIBE`
2. –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `GRAPH_STATE` —Å –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
3. –ö–ª–∏–µ–Ω—Ç –≤ `handleGraphState` –≤—ã–∑—ã–≤–∞–µ—Ç `setRootNodes(graphState.nodes)`
4. `setRootNodes` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–µ—Å—å –º–∞—Å—Å–∏–≤ –∫–∞–∫ –∫–æ—Ä–Ω–µ–≤—ã–µ –Ω–æ–¥—ã

## –†–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
–û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `handleGraphState` —á—Ç–æ–±—ã –æ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª –∏–µ—Ä–∞—Ä—Ö–∏—é:

```javascript
const handleGraphState = (graphState) => {
  console.log('üìä TreeDaoStore: Loading initial graph state', graphState);
  if (graphState && graphState.nodes) {
    // graphState.nodes —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    // —Å children –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –Ω–æ–¥—ã
    self.setRootNodes(graphState.nodes);
    
    if (graphState.edges) {
      self.setAllEdges(graphState.edges);
    }
    console.log('  ‚úÖ Graph state loaded successfully');
  }
};
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```javascript
// –í simple-server.js, –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ GRAPH_STATE
const graph = await getGraph(data.graphId);

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
console.log('Graph structure check:');
graph.nodes.forEach((node, i) => {
  console.log(`  Node ${i}: ${node.title}, children: ${node.children?.length || 0}`);
});

ws.send(JSON.stringify({
  type: 'GRAPH_STATE',
  payload: graph
}));
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏—è

1. –û—á–∏—Å—Ç–∏—Ç—å Redis:
```bash
docker exec -it optimistic-redis redis-cli FLUSHALL
```

2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä:
```bash
docker-compose restart optimistic-backend
```

3. –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É:
   - –°–æ–∑–¥–∞—Ç—å –∫–æ—Ä–Ω–µ–≤—É—é –Ω–æ–¥—É
   - –ù–∞–≤–∏–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –Ω–µ—ë
   - –°–æ–∑–¥–∞—Ç—å –¥–æ—á–µ—Ä–Ω—é—é –Ω–æ–¥—É
   - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É

4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–µ—Ä–∞—Ä—Ö–∏—è —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞

–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `setRootNodes`:

```javascript
setRootNodes(nodes) {
  console.log('TreeDaoStore.setRootNodes called with:', nodes);
  console.log('First node structure:', JSON.stringify(nodes[0], null, 2));
  
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç–æ–ª—å–∫–æ –∫–æ—Ä–Ω–µ–≤—ã–µ –Ω–æ–¥—ã
  const allNodeIds = new Set();
  const childNodeIds = new Set();
  
  const collectIds = (nodeArray) => {
    nodeArray.forEach(node => {
      allNodeIds.add(node.id);
      if (node.children && node.children.length > 0) {
        node.children.forEach(child => childNodeIds.add(child.id));
        collectIds(node.children);
      }
    });
  };
  
  collectIds(nodes);
  console.log(`Total nodes: ${allNodeIds.size}, Child nodes: ${childNodeIds.size}`);
  console.log(`Root nodes: ${allNodeIds.size - childNodeIds.size}`);
  
  // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥...
}
```

## –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ `setRootNodes` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º–µ–Ω–Ω–æ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∞ –Ω–µ –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –Ω–æ–¥.

–í Redis –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (—Å children), –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–º, –∫–∞–∫ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.