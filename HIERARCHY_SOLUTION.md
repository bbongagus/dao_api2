# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π parent-child –ø—Ä–∏ WebSocket –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ—á–µ—Ä–Ω–∏—Ö –Ω–æ–¥ —á–µ—Ä–µ–∑ WebSocket (real-time –æ–ø–µ—Ä–∞—Ü–∏–∏), –æ–Ω–∏ –ø–æ—è–≤–ª—è–ª–∏—Å—å –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º —É—Ä–æ–≤–Ω–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–æ–¥.

## –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã
1. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–æ—á–µ—Ä–Ω–µ–π –Ω–æ–¥—ã, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–ª —Ç–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏—é `ADD_NODE` —Å `parentId`
2. –°–µ—Ä–≤–µ—Ä –¥–æ–±–∞–≤–ª—è–ª –Ω–æ–≤—É—é –Ω–æ–¥—É –≤ Redis, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –Ω–æ–¥—É
3. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≥—Ä–∞—Ñ–∞ –∏–∑ Redis, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±—ã–ª–∞ –Ω–µ–ø–æ–ª–Ω–æ–π

## –†–µ—à–µ–Ω–∏–µ

### 1. –§—Ä–æ–Ω—Ç–µ–Ω–¥ (graphy/stores/models/TreeDaoStore.js)
–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–æ—á–µ—Ä–Ω–µ–π –Ω–æ–¥—ã —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –î–í–ï –æ–ø–µ—Ä–∞—Ü–∏–∏:

```javascript
// Send to optimistic backend via WebSocket
if (!IS_TEST && optimisticIntegration.isConnected) {
  const parentId = currentNode ? currentNode.id : null;
  
  // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ADD_NODE –¥–ª—è –Ω–æ–≤–æ–π –Ω–æ–¥—ã
  optimisticIntegration.interceptNodeAdd(newNode, parentId);
  
  // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º UPDATE_NODE –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º children
  if (currentNode) {
    const parentSnapshot = getSnapshot(currentNode);
    optimisticIntegration.interceptNodeUpdate(currentNode.id, {
      children: parentSnapshot.children,
      nodeSubtype: currentNode.nodeSubtype
    });
  }
}
```

### 2. –°–µ—Ä–≤–µ—Ä (dao_api2/src/simple-server.js)

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ ADD_NODE:
- –ù–∞—Ö–æ–¥–∏—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –Ω–æ–¥—É –ø–æ `parentId`
- –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –Ω–æ–¥—É –≤ `children` —Ä–æ–¥–∏—Ç–µ–ª—è
- –û–±–Ω–æ–≤–ª—è–µ—Ç `nodeSubtype` —Ä–æ–¥–∏—Ç–µ–ª—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –õ–æ–≥–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```javascript
case 'ADD_NODE':
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –Ω–æ–¥—ã ...
  
  if (payload.parentId) {
    const findAndAddToParent = (nodes, depth = 0) => {
      for (let node of nodes) {
        if (node.id === payload.parentId) {
          if (!node.children) node.children = [];
          node.children.push(newNode);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º subtype —Ä–æ–¥–∏—Ç–µ–ª—è
          if (node.nodeType === 'dao' && node.nodeSubtype === 'simple') {
            node.nodeSubtype = 'withChildren';
          }
          return true;
        }
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∏—â–µ–º –≤ –¥–µ—Ç—è—Ö
        if (node.children && node.children.length > 0) {
          if (findAndAddToParent(node.children, depth + 1)) return true;
        }
      }
      return false;
    };
    
    findAndAddToParent(graph.nodes);
  }
  break;
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ UPDATE_NODE:
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ `children`
- –û–±–Ω–æ–≤–ª—è–µ—Ç `nodeSubtype` –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
- –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç –Ω–æ–¥—É –≤ –∏–µ—Ä–∞—Ä—Ö–∏–∏

```javascript
case 'UPDATE_NODE':
  const updateNodeRecursive = (nodes) => {
    for (let node of nodes) {
      if (node.id === payload.id) {
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è children
        if (payload.updates.children !== undefined) {
          node.children = payload.updates.children;
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
        Object.assign(node, payload.updates);
        return true;
      }
      // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∏—â–µ–º –≤ –¥–µ—Ç—è—Ö
      if (node.children && node.children.length > 0) {
        if (updateNodeRecursive(node.children)) return true;
      }
    }
    return false;
  };
  updateNodeRecursive(graph.nodes);
  break;
```

## –ü–æ—Ç–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π

### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ—á–µ—Ä–Ω–µ–π –Ω–æ–¥—ã:
1. **–õ–æ–∫–∞–ª—å–Ω–æ**: 
   - `currentNode.adoptNode(newNode)` - –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–æ—á–µ—Ä–Ω—é—é –Ω–æ–¥—É
   - `currentNode.setNodeSubtype('withChildren')` - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∏–ø —Ä–æ–¥–∏—Ç–µ–ª—è

2. **WebSocket –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç**:
   - `ADD_NODE` —Å `parentId` - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –Ω–æ–¥—ã
   - `UPDATE_NODE` –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ children

3. **–°–µ—Ä–≤–µ—Ä**:
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `ADD_NODE` - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–¥—É (–Ω–æ —ç—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `UPDATE_NODE` - –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Redis –ø–æ–ª–Ω—É—é –∏–µ—Ä–∞—Ä—Ö–∏—é
   - –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º

4. **–î—Ä—É–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã**:
   - –ü—Ä–∏–º–µ–Ω—è—é—Ç `ADD_NODE` –æ–ø–µ—Ä–∞—Ü–∏—é
   - –ü—Ä–∏–º–µ–Ω—è—é—Ç `UPDATE_NODE` –æ–ø–µ—Ä–∞—Ü–∏—é
   - –ü–æ–ª—É—á–∞—é—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–µ—Ä–∞—Ä—Ö–∏—é

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. **–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –Ω–æ–¥–∞ –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–π
2. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Å WebSocket, —Ç–∞–∫ –∏ —Å REST API (–∫–Ω–æ–ø–∫–∞ Save)
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –î–∞–∂–µ –µ—Å–ª–∏ –æ–¥–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
4. **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∞ –º–µ–∂–¥—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º –∏ –±—ç–∫–µ–Ω–¥–æ–º

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –°–æ–∑–¥–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –Ω–æ–¥—É
2. –ù–∞–≤–∏–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤–Ω—É—Ç—Ä—å
3. –°–æ–∑–¥–∞—Ç—å –¥–æ—á–µ—Ä–Ω—é—é –Ω–æ–¥—É
4. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
5. ‚úÖ –î–æ—á–µ—Ä–Ω—è—è –Ω–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ —Ä–æ–¥–∏—Ç–µ–ª—è

## –û—Ç–ª–∞–¥–∫–∞

–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ—á–µ—Ä–Ω–µ–π –Ω–æ–¥—ã:
```
üöÄ Intercepting node add: "New Node" with parentId: abc-123
üì¶ ADD_NODE payload: {...}
üîÑ Also sending UPDATE for parent node abc-123 with 1 children
```

–í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞:
```
Looking for parent abc-123 to add child xyz-789
‚úÖ Found parent and added child at depth 0
üìù Updated parent subtype to 'withChildren'
üìä After ADD_NODE - Graph has 2 root nodes
üìä Total nodes in hierarchy: 3
```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)

1. **–¢–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä**: –°–µ—Ä–≤–µ—Ä –º–æ–≥ –±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è, –Ω–æ —ç—Ç–æ —Å–æ–∑–¥–∞–ª–æ –±—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É
2. **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞**: –ú–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –≤–µ—Å—å –≥—Ä–∞—Ñ, –Ω–æ —ç—Ç–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
3. **–û—Ç–¥–µ–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è**: –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é ADD_CHILD, –Ω–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω–∏—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ—à–µ–Ω–∏–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏ parent-child –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ WebSocket –æ–ø–µ—Ä–∞—Ü–∏–π, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º –ø—Ä–æ—Å—Ç–æ—Ç—É –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã Optimistic UI.