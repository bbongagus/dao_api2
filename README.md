# üöÄ Optimistic UI Backend - Simple Version

–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π backend –¥–ª—è Graphy —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Optimistic UI, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –Ω–∞ Redis –∏ BullMQ.

## ‚ú® –ß—Ç–æ —ç—Ç–æ?

–ü—Ä–æ—Å—Ç–æ–π backend (–≤—Å–µ–≥–æ ~1000 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞), –∫–æ—Ç–æ—Ä—ã–π –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI** - –∫–ª–∏–µ–Ω—Ç –Ω–µ –∂–¥–µ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
- **Redis –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã** - –±—ã—Å—Ç—Ä–æ–µ –∏ –Ω–∞–¥–µ–∂–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- **BullMQ –¥–ª—è –∫–æ–º–∞–Ω–¥** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏
- **WebSocket –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏** - real-time –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
dao_api2/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.js       # API —Å–µ—Ä–≤–µ—Ä (Express)
‚îÇ   ‚îú‚îÄ‚îÄ redis.js       # –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ queue.js       # –û—á–µ—Ä–µ–¥—å –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îú‚îÄ‚îÄ worker.js      # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îî‚îÄ‚îÄ websocket.js   # WebSocket —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ client/
‚îÇ   ‚îî‚îÄ‚îÄ optimisticApi.js  # –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
‚îî‚îÄ‚îÄ docker-compose.yml     # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 1: –° Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É
cd dao_api2

# 2. –ö–æ–ø–∏—Ä—É–µ–º .env
cp .env.example .env

# 3. –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d

# –ì–æ—Ç–æ–≤–æ! 
# API: http://localhost:3000
# WebSocket: ws://localhost:8080
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# 2. –ö–æ–ø–∏—Ä—É–µ–º .env
cp .env.example .env

# 3. –ó–∞–ø—É—Å–∫–∞–µ–º Redis (–Ω—É–∂–µ–Ω Docker)
docker run -d -p 6379:6379 redis:7-alpine

# 4. –ó–∞–ø—É—Å–∫–∞–µ–º backend (–≤ —Ä–∞–∑–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–∞—Ö)
npm run api      # Terminal 1: API —Å–µ—Ä–≤–µ—Ä
npm run worker   # Terminal 2: Worker –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥

# –ò–ª–∏ –≤—Å–µ –≤–º–µ—Å—Ç–µ:
npm start
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
npm test

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å health
curl http://localhost:3000/health
```

## üì° API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```javascript
// –ü–æ–ª—É—á–∏—Ç—å –≥—Ä–∞—Ñ
GET /api/graphs/:graphId

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å—å –≥—Ä–∞—Ñ
POST /api/graphs/:graphId
Body: { nodes: [...], edges: [...], viewport: {...} }

// –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É (optimistic)
POST /api/graphs/:graphId/command
Body: { 
  type: "ADD_NODE" | "UPDATE_NODE" | "DELETE_NODE" | ...,
  payload: {...}
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏
GET /api/operations/:jobId
```

### –¢–∏–ø—ã –∫–æ–º–∞–Ω–¥

- `ADD_NODE` - –¥–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª
- `UPDATE_NODE` - –æ–±–Ω–æ–≤–∏—Ç—å —É–∑–µ–ª  
- `UPDATE_NODE_POSITION` - –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
- `DELETE_NODE` - —É–¥–∞–ª–∏—Ç—å —É–∑–µ–ª
- `ADD_EDGE` - –¥–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å
- `DELETE_EDGE` - —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å
- `UPDATE_VIEWPORT` - –æ–±–Ω–æ–≤–∏—Ç—å viewport
- `BATCH_UPDATE` - –ø–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- `SAVE_GRAPH` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å—å –≥—Ä–∞—Ñ

## üíª –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Frontend

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞

```javascript
// –°–∫–æ–ø–∏—Ä—É–π—Ç–µ client/optimisticApi.js –≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
import OptimisticAPI from './services/optimisticApi';

const api = new OptimisticAPI({
  apiUrl: 'http://localhost:3000/api',
  wsUrl: 'ws://localhost:8080',
  graphId: 'main'
});
```

### 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```javascript
// –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
await api.connect();

// –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä–∞—Ñ
const graph = await api.loadGraph();
```

### 3. Optimistic –æ–ø–µ—Ä–∞—Ü–∏–∏

```javascript
// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–∑–ª–∞ (UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É)
const node = await api.addNode({
  title: 'New Node',
  position: { x: 100, y: 100 }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
await api.updateNodePosition(nodeId, { x: 200, y: 200 });

// –£–¥–∞–ª–µ–Ω–∏–µ —É–∑–ª–∞
await api.deleteNode(nodeId);
```

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

```javascript
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
api.onUpdate = (message) => {
  console.log('Server confirmed:', message);
  // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–æ—Ç–∫–∞—Ç optimistic updates)
api.onError = (error) => {
  console.log('Need to revert:', error);
  // –û—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ UI
};
```

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

1. **–ö–ª–∏–µ–Ω—Ç** –¥–µ–ª–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏ —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ—Ç UI (optimistic)
2. **API** –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –∏ —Å—Ç–∞–≤–∏—Ç –≤ –æ—á–µ—Ä–µ–¥—å BullMQ
3. **Worker** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Redis
4. **WebSocket** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
5. **–ö–ª–∏–µ–Ω—Ç** –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **Latency**: < 50ms –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
- **Throughput**: 1000+ –æ–ø–µ—Ä–∞—Ü–∏–π/—Å–µ–∫
- **Redis memory**: ~1MB –Ω–∞ 1000 —É–∑–ª–æ–≤
- **WebSocket**: –¥–æ 1000 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

## üõ†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Environment Variables

```bash
# Server
PORT=3000
WS_PORT=8080

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# CORS (–¥–ª—è frontend)
CORS_ORIGINS=http://localhost:5173
```

### Docker –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `docker-compose.yml`:
- Redis –ø–∞–º—è—Ç—å: `--maxmemory 256mb`
- Redis –ø–æ–ª–∏—Ç–∏–∫–∞: `--maxmemory-policy allkeys-lru`

## üìà –†–∞–∑–≤–∏—Ç–∏–µ

### –≠—Ç–∞–ø 1: –°–µ–π—á–∞—Å ‚úÖ
- –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ CRUD
- Optimistic UI
- WebSocket —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –≠—Ç–∞–ø 2: –°–∫–æ—Ä–æ
- [ ] Undo/Redo
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### –≠—Ç–∞–ø 3: –ü–æ—Ç–æ–º
- [ ] –ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º
- [ ] –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

## üêõ –û—Ç–ª–∞–¥–∫–∞

```bash
# –õ–æ–≥–∏ Docker
docker-compose logs -f

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
docker exec dao-redis redis-cli
> KEYS *
> GET graph:main

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–∏
curl http://localhost:3000/api/operations/:jobId
```

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

---

**–ü—Ä–æ—Å—Ç–æ–π, –±—ã—Å—Ç—Ä—ã–π, –Ω–∞–¥–µ–∂–Ω—ã–π backend –¥–ª—è Optimistic UI!** üöÄ