# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏–µ—Ä–∞—Ä—Ö–∏–∏ WebSocket

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

1. –û—á–∏—Å—Ç–∏—Ç–µ Redis –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞:
```bash
docker exec -it optimistic-redis redis-cli FLUSHALL
```

2. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (F12)

3. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Graphy: http://localhost:5173

## –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏ —á–µ—Ä–µ–∑ WebSocket

1. **–°–æ–∑–¥–∞–π—Ç–µ –∫–æ—Ä–Ω–µ–≤—É—é –Ω–æ–¥—É**
   - –ù–∞–∂–º–∏—Ç–µ "d" –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ UI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è DAO –Ω–æ–¥—ã
   - –ù–∞–∑–æ–≤–∏—Ç–µ –µ—ë "Parent Node"
   - –í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
   ```
   üöÄ Sending operation: ADD_NODE
   ```

2. **–ù–∞–≤–∏–≥–∏—Ä—É–π—Ç–µ—Å—å –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –Ω–æ–¥—É**
   - –î–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ "Parent Node"
   - –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –ø—É—Å—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≤–Ω—É—Ç—Ä–∏ –Ω–æ–¥—ã

3. **–°–æ–∑–¥–∞–π—Ç–µ –¥–æ—á–µ—Ä–Ω—é—é –Ω–æ–¥—É**
   - –ù–∞–∂–º–∏—Ç–µ "d" —Å–Ω–æ–≤–∞
   - –ù–∞–∑–æ–≤–∏—Ç–µ –µ—ë "Child Node"
   - –í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
   ```
   Intercepting node add with parentId: <parent_id>
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞**
   - –í –ª–æ–≥–∞—Ö Docker –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```
   üìä Graph structure check before sending:
     Root nodes: 1
     Node "Parent Node" has 1 children
     Total nodes in hierarchy: 2
   ```

5. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)**

6. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**
   - ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞**: –û–±–µ –Ω–æ–¥—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
   - ‚úÖ **–û–∂–∏–¥–∞–µ–º–æ**: "Parent Node" –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ, "Child Node" –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë

## –¢–µ—Å—Ç 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É Save

1. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —à–∞–≥–∏ 1-3 –∏–∑ –¢–µ—Å—Ç–∞ 1

2. **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Save"** –≤ UI

3. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É**

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**
   - ‚úÖ –ò–µ—Ä–∞—Ä—Ö–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
üìä TreeDaoStore: Loading initial graph state
  ‚Üí Loading 1 nodes and 0 edges  // <-- –ü—Ä–æ–±–ª–µ–º–∞ –µ—Å–ª–∏ –∑–¥–µ—Å—å 2 nodes!
  ‚úÖ Graph state loaded successfully
```

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö Docker

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ backend
docker logs -f optimistic-backend --tail 50
```

–ò—â–∏—Ç–µ:
1. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:
   ```
   üíæ Saving graph main: 1 nodes, 0 edges
   ```

2. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:
   ```
   üìä Graph structure check before sending:
     Root nodes: 1
     Node "Parent Node" has 1 children
     Total nodes in hierarchy: 2
   ```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Redis

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Redis
docker exec -it optimistic-redis redis-cli

# –ü–æ–ª—É—á–∏—Ç—å –≥—Ä–∞—Ñ
GET graph:main

# –í—ã–π—Ç–∏
exit
```

–î–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:
```json
{
  "nodes": [
    {
      "id": "xxx",
      "title": "Parent Node",
      "children": [
        {
          "id": "yyy",
          "title": "Child Node",
          "children": []
        }
      ]
    }
  ],
  "edges": []
}
```

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ï—Å–ª–∏ –∏–µ—Ä–∞—Ä—Ö–∏—è –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ parentId –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è**
   - –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ—á–µ—Ä–Ω–µ–π –Ω–æ–¥—ã
   - –í payload –æ–ø–µ—Ä–∞—Ü–∏–∏ ADD_NODE

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
   - –õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–µ—Ä–∞—Ä—Ö–∏—é
   - Redis –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ**
   - handleGraphState –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
   - setRootNodes –¥–æ–ª–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –µ—ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å

## –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "Save" –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã - –æ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏—é —á–µ—Ä–µ–∑ REST API.

## –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ `GRAPH_STATE` –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ. –ù—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ:

1. –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É (—É–∂–µ –¥–µ–ª–∞–µ—Ç)
2. –ö–ª–∏–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –µ—ë –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –≤ `handleGraphState`
3. `setRootNodes` –Ω–µ "—Å–ø–ª—é—â–∏–≤–∞–µ—Ç" —Å—Ç—Ä—É–∫—Ç—É—Ä—É

–†–µ—à–µ–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `HIERARCHY_FIX.md`