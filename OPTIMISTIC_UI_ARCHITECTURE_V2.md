# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Optimistic UI Backend v2.0
## –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ Graphy Frontend

## üìä –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Graphy

### Frontend Stack:
- **State Management**: MobX-State-Tree (MST)
- **UI**: React Flow –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
- **Real-time**: WebSocket —á–µ—Ä–µ–∑ OptimisticIntegration
- **API**: REST + WebSocket –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- **Storage**: localStorage –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–∞

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
1. **TreeDaoStore** - –æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   - –£–ø—Ä–∞–≤–ª—è–µ—Ç —É–∑–ª–∞–º–∏ (nodes) –∏ —Å–≤—è–∑—è–º–∏ (edges)
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ —É—Ä–æ–≤–Ω—è–º
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á

2. **OptimisticIntegration** - WebSocket –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
   - –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ TreeDaoStore
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ backend —á–µ—Ä–µ–∑ WebSocket
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –ò–º–µ–µ—Ç –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω –æ–ø–µ—Ä–∞—Ü–∏–π

3. **GraphAPI** - REST API –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ó–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥—Ä–∞—Ñ–∞
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –≥—Ä–∞—Ñ–∞–º–∏
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

## üéØ –¶–µ–ª–∏ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –º–∏–Ω–∏–º—É–º –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π, –∫–∞–∫ –≤ Figma/Miro
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - Redis –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ multi-user –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Backend (dao_api2)

### –£—Ä–æ–≤–µ–Ω—å 1: WebSocket Server
```javascript
// –ü—Ä–æ—Å—Ç–æ–π WebSocket —Å–µ—Ä–≤–µ—Ä –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π
class OptimisticServer {
  // –ü—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å Redis
  // Broadcast –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
  // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
}
```

### –£—Ä–æ–≤–µ–Ω—å 2: Redis Storage
```javascript
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Redis
{
  // –ì—Ä–∞—Ñ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  "graph:main": {
    nodes: [],
    edges: [],
    viewport: {},
    version: 1
  },
  
  // –û–ø–µ—Ä–∞—Ü–∏–∏ (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏/undo)
  "operations:main": [
    { type: "ADD_NODE", payload: {...}, timestamp: ... }
  ],
  
  // –°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  "sessions": {
    "user1": { graphId: "main", lastSeen: ... }
  }
}
```

### –û–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ WebSocket

```javascript
// Frontend -> Backend
{
  type: "ADD_NODE",
  payload: {
    id: "node-1",
    title: "New Task",
    position: { x: 100, y: 200 },
    nodeType: "dao"
  }
}

// Backend -> All Clients
{
  type: "NODE_ADDED",
  payload: { ... },
  userId: "user1",
  timestamp: 1234567890
}
```

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### Optimistic Update Flow:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –¥–µ–ª–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ (–¥–æ–±–∞–≤–ª—è–µ—Ç —É–∑–µ–ª)
2. **TreeDaoStore** —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
3. **OptimisticIntegration** –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é
4. **WebSocket** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä
5. **Server** –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫ Redis –∏ broadcast –≤—Å–µ–º
6. **–î—Ä—É–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã** –ø–æ–ª—É—á–∞—é—Ç –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ

### –ó–∞–≥—Ä—É–∑–∫–∞/–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:
1. **REST API** –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
2. **WebSocket** –¥–ª—è –≤—Å–µ—Ö runtime –æ–ø–µ—Ä–∞—Ü–∏–π
3. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** –ø–æ–ª–Ω–æ–≥–æ snapshot –≤ Redis

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ dao_api2

```
dao_api2/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ server.js           # –û—Å–Ω–æ–≤–Ω–æ–π WebSocket + REST —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ redis.js            # Redis –∫–ª–∏–µ–Ω—Ç –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ operations.js       # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ validation.js       # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îú‚îÄ‚îÄ docker-compose.yml      # Redis + Node.js –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ .env.example
```

## üîå API Endpoints

### REST (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º):
- `GET /api/graphs/:graphId` - –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ
- `POST /api/graphs/:graphId` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä–∞—Ñ
- `GET /api/users/:userId/graphs` - —Å–ø–∏—Å–æ–∫ –≥—Ä–∞—Ñ–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### WebSocket Events:
- `connection` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
- `subscribe` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≥—Ä–∞—Ñ
- `operation` - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `sync` - –∑–∞–ø—Ä–æ—Å –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

1. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - frontend –ø–æ—á—Ç–∏ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - 300-400 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤–º–µ—Å—Ç–æ —Ç—ã—Å—è—á
3. **–°–∫–æ—Ä–æ—Å—Ç—å** - –ø—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å Redis
4. **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π
5. **–û—Ç–ª–∞–¥–∫–∞** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã

## üîß –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Node.js** - —Å–µ—Ä–≤–µ—Ä
- **ws** - WebSocket –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
- **Redis** - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- **Express** - REST API
- **Docker** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è

## üìù –ú–∏–≥—Ä–∞—Ü–∏—è —Å —Ç–µ–∫—É—â–µ–≥–æ backend

### –≠—Ç–∞–ø 1: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞
- –ù–æ–≤—ã–π backend –Ω–∞ –ø–æ—Ä—Ç—É 3001
- –°—Ç–∞—Ä—ã–π backend –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- Frontend –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –Ω–∏–º–∏

### –≠—Ç–∞–ø 2: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å
- –ù–∞—á–∏–Ω–∞–µ–º —Å WebSocket –æ–ø–µ—Ä–∞—Ü–∏–π
- REST endpoints –æ—Å—Ç–∞—é—Ç—Å—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –î–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∏—Ä—É—é—Ç—Å—è –≤ Redis

### –≠—Ç–∞–ø 3: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
- –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π backend
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π Optimistic Backend
- Cleanup —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞

## üé® –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### Server (–ø—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π):
```javascript
const WebSocket = require('ws');
const redis = require('./redis');

const wss = new WebSocket.Server({ port: 3001 });

wss.on('connection', (ws) => {
  ws.on('message', async (data) => {
    const { type, payload } = JSON.parse(data);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –∫ Redis
    await redis.applyOperation(type, payload);
    
    // Broadcast –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
    wss.clients.forEach(client => {
      if (client.readyState === WebSocket.OPEN) {
        client.send(JSON.stringify({ type, payload }));
      }
    });
  });
});
```

### Redis Operations:
```javascript
async function applyOperation(type, payload) {
  const graph = await getGraph(payload.graphId);
  
  switch(type) {
    case 'ADD_NODE':
      graph.nodes.push(payload.node);
      break;
    case 'DELETE_NODE':
      graph.nodes = graph.nodes.filter(n => n.id !== payload.nodeId);
      break;
    case 'UPDATE_NODE':
      const node = graph.nodes.find(n => n.id === payload.id);
      Object.assign(node, payload.updates);
      break;
  }
  
  await saveGraph(payload.graphId, graph);
}
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π

| –ê—Å–ø–µ–∫—Ç | –¢–µ–∫—É—â–∞—è (dao_api) | –ù–æ–≤–∞—è (dao_api2) |
|--------|-------------------|------------------|
| –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í—ã—Å–æ–∫–∞—è (BullMQ, –≤–æ—Ä–∫–µ—Ä—ã) | –ù–∏–∑–∫–∞—è (–ø—Ä—è–º–æ–π WebSocket) |
| –ö–æ–¥ | ~2000+ —Å—Ç—Ä–æ–∫ | ~400 —Å—Ç—Ä–æ–∫ |
| –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | 15+ –ø–∞–∫–µ—Ç–æ–≤ | 5 –ø–∞–∫–µ—Ç–æ–≤ |
| Latency | 50-100ms | <10ms |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ | –°–ª–æ–∂–Ω–æ–µ | –ü—Ä–æ—Å—Ç–æ–µ (Redis Cluster) |

## ‚úÖ Checklist –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker —Å Redis
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å REST endpoints –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å API
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **Conflict Resolution** - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
2. **Undo/Redo** - –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤ Redis
3. **Permissions** - –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –≥—Ä–∞—Ñ–∞–º
4. **Presence** - –ø–æ–∫–∞–∑ –∫—É—Ä—Å–æ—Ä–æ–≤ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
5. **Offline Support** - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞